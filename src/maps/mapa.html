<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geocodificación y Puntos de Interés con OpenStreetMap</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    label {
      font-weight: bold;
    }
    input[type="text"] {
      width: 300px;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #map {
      height: 600px; /* Ajusta la altura del mapa según tus necesidades */
      width: 100%;
      margin-top: 20px;
    }
    #results {
      margin-top: 20px;
    }
    .poi-list {
      list-style-type: none;
      padding: 0;
      margin-top: 10px;
    }
    .poi-item {
      margin-bottom: 5px;
    }
  </style>

  <!-- Incluir la librería Leaflet para OpenStreetMap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
  <h1>Geocodificación y Puntos de Interés con OpenStreetMap</h1>
  <div>
    <label for="address">Ingrese una dirección:</label><br>
    <input type="text" id="addressInput" placeholder="Ej. Calle Falsa 123, Ciudad Ficticia"><br>
    <button onclick="geocodeAddress()">Geocodificar Dirección</button>
  </div>
  <div id="results">
    <!-- Aquí se mostrarán los resultados -->
  </div>

  <!-- Contenedor para el mapa -->
  <div id="map"></div>

  <!-- Lista de puntos de interés -->
  <div id="poiResults">
    <h2>Puntos de Interés Cercanos:</h2>
    <ul id="poiList" class="poi-list">
      <!-- Aquí se mostrarán los puntos de interés -->
    </ul>
  </div>

  <!-- Incluir la librería Leaflet para OpenStreetMap -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    let map;

    async function geocodeAddress() {
      const addressInput = document.getElementById('addressInput').value.trim();
      if (!addressInput) {
        alert('Por favor, ingrese una dirección.');
        return;
      }

      try {
        const response = await fetch('http://localhost:3000/maps/geocode', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ address: addressInput })
        });

        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        displayResults(data);
        showMap(data);
        fetchPOIs(data.lat, data.lon);

      } catch (error) {
        console.error('Error al geocodificar la dirección:', error.message);
        alert('Error al geocodificar la dirección. Verifique la consola para más detalles.');
      }
    }

    function displayResults(data) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `
        <h2>Resultados:</h2>
        <p><strong>Latitud:</strong> ${data.lat}</p>
        <p><strong>Longitud:</strong> ${data.lon}</p>
        <p><strong>Nombre del lugar:</strong> ${data.display_name}</p>
        <p><strong>País:</strong> ${data.country}</p>
        <p><strong>Región:</strong> ${getRegion(data)}</p>
      `;
    }

    function showMap(data) {
      map = L.map('map').setView([data.lat, data.lon], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      L.marker([data.lat, data.lon]).addTo(map)
        .bindPopup(`<b>${data.display_name}</b><br>${data.city}, ${data.state}, ${data.country}`)
        .openPopup();

      // Detectar el evento de cambio de zoom
      map.on('zoomend', async function() {
        const zoomLevel = map.getZoom();
        console.log('Zoom level:', zoomLevel);

        // Si el zoom es mayor o igual a 14, buscar puntos turísticos más importantes
        if (zoomLevel >= 14) {
          await fetchImportantPOIs(data.lat, data.lon);
        }
      });
    }

    async function fetchPOIs(lat, lon) {
      try {
        // Buscar hoteles cercanos
        const hotelsResponse = await fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node(around:1000,${lat},${lon})["tourism"="hotel"];out;`);
        const hotelsData = await hotelsResponse.json();
        displayPOIs(hotelsData.elements.filter(poi => poi.tags.name), 'Hoteles');

        // Buscar restaurantes cercanos
        const restaurantsResponse = await fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node(around:1000,${lat},${lon})["amenity"="restaurant"];out;`);
        const restaurantsData = await restaurantsResponse.json();
        displayPOIs(restaurantsData.elements.filter(poi => poi.tags.name), 'Restaurantes');

        // Buscar atracciones turísticas importantes cercanas
        const touristAttractionsResponse = await fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node(around:2000,${lat},${lon})["tourism"];out;`);
        const touristAttractionsData = await touristAttractionsResponse.json();
        displayPOIs(touristAttractionsData.elements.filter(poi => poi.tags.name), 'Atracciones Turísticas');
      } catch (error) {
        console.error('Error al obtener puntos de interés:', error.message);
        alert('Error al obtener puntos de interés. Verifique la consola para más detalles.');
      }
    }

    async function fetchImportantPOIs(lat, lon) {
      try {
        // Buscar puntos turísticos importantes (ampliado el rango)
        const importantPOIsResponse = await fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node(around:5000,${lat},${lon})["tourism"];out;`);
        const importantPOIsData = await importantPOIsResponse.json();
        displayPOIs(importantPOIsData.elements.filter(poi => poi.tags.name), 'Puntos Turísticos Importantes');
      } catch (error) {
        console.error('Error al obtener puntos turísticos importantes:', error.message);
        alert('Error al obtener puntos turísticos importantes. Verifique la consola para más detalles.');
      }
    }

    function displayPOIs(pois, category) {
      const poiList = document.getElementById('poiList');

      // Limpiar la lista antes de añadir nuevos elementos
      poiList.innerHTML = '';

      pois.forEach(poi => {
        const name = poi.tags.name || 'Punto de interés sin nombre';
        const address = poi.tags.address ? `, ${poi.tags.address}` : '';
        const li = document.createElement('li');
        li.classList.add('poi-item');
        li.textContent = `${category}: ${name}${address}`;
        poiList.appendChild(li);
        
        // Mostrar el marcador en el mapa para cada punto de interés con nombre
        if (poi.tags.name) {
          const poiMarker = L.marker([poi.lat, poi.lon]).addTo(map)
            .bindPopup(`<b>${name}</b><br>${address}`);
        }
      });
    }

    function getRegion(data) {
  const lat = parseFloat(data.lat);
  const lon = parseFloat(data.lon);

  // Definir los límites geográficos para cada región
  const regiones = {
    'Litoral': [
      { latMin: -28, latMax: -22, lonMin: -61, lonMax: -57 },  // Formosa
      { latMin: -28, latMax: -22, lonMin: -63, lonMax: -57 },  // Chaco
      { latMin: -28, latMax: -22, lonMin: -56, lonMax: -54 },  // Misiones
      { latMin: -29, latMax: -28, lonMin: -61, lonMax: -57 },  // Corrientes
      { latMin: -34, latMax: -28, lonMin: -65, lonMax: -57 },  // Santa Fe
      { latMin: -34, latMax: -28, lonMin: -65, lonMax: -57 }   // Entre Ríos
    ],
    'Noroeste': [
      { latMin: -27, latMax: -23, lonMin: -67, lonMax: -63 },  // Jujuy
      { latMin: -27, latMax: -22, lonMin: -68, lonMax: -64 },  // Salta
      { latMin: -28, latMax: -27, lonMin: -68, lonMax: -64 },  // Catamarca
      { latMin: -31, latMax: -28, lonMin: -68, lonMax: -64 },  // La Rioja
      { latMin: -28, latMax: -26, lonMin: -67, lonMax: -64 },  // Tucumán
      { latMin: -29, latMax: -27, lonMin: -65, lonMax: -63 }   // Santiago del Estero
    ],
    'Cuyo': [
      { latMin: -35, latMax: -28, lonMin: -70, lonMax: -65 },  // San Juan
      { latMin: -36, latMax: -31, lonMin: -71, lonMax: -66 },  // Mendoza
      { latMin: -36, latMax: -32, lonMin: -68, lonMax: -65 }   // San Luis
    ],
    'Patagonia': [
      { latMin: -42, latMax: -36, lonMin: -73, lonMax: -65 },  // Neuquén
      { latMin: -42, latMax: -38, lonMin: -70, lonMax: -62 },  // Río Negro
      { latMin: -46, latMax: -41, lonMin: -74, lonMax: -65 },  // Chubut
      { latMin: -51, latMax: -45, lonMin: -74, lonMax: -62 }   // Santa Cruz
    ],
    'Extremo austral': [
      { latMin: -55, latMax: -50, lonMin: -75, lonMax: -60 }   // Tierra del Fuego, Antártida e Islas del Atlántico Sur
    ],
    'Pampeana': [
      { latMin: -41, latMax: -32, lonMin: -64, lonMax: -57 },  // Buenos Aires
      { latMin: -39, latMax: -33, lonMin: -66, lonMax: -61 },  // La Pampa
      { latMin: -34, latMax: -28, lonMin: -66, lonMax: -58 }   // Córdoba
    ]
  };

  // Función para verificar si las coordenadas están dentro de una región específica
  function isInRegion(lat, lon, regionCoords) {
    return regionCoords.some(coords =>
      lat >= coords.latMin && lat <= coords.latMax &&
      lon >= coords.lonMin && lon <= coords.lonMax
    );
  }

  // Verificar cada región y devolver el nombre si las coordenadas están dentro de ella
  for (const [region, coords] of Object.entries(regiones)) {
    if (isInRegion(lat, lon, coords)) {
      return region;
    }
  }

  // Si no pertenece a ninguna región conocida, devolver 'Otra región'
  return 'Otra región';
}

  </script>
